#  부하 테스트 결과 보고서

## 1. 테스트 결과 분석

### 주요 성능 지표

| 항목                | 측정값                                 |
|-------------------|-------------------------------------|
| **총 요청 수**        | 8668 건                              |
| **성공 요청 비율**      | 50.00% ( 쿠폰 발급 요청 성공: 200 응답)       |
| **오류 발생 비율**      | 0% ( 서버 오류 없음, 500 응답 없음)           |
| **평균 응답 시간**      | 6.38초 (`http_req_duration`)         |
| **95% 응답 시간**     | 12.46초 (`p(95)`)                    |
| **99% 응답 시간**     | 13.59초 (`max`)                      |
| **최대 응답 시간**      | 13.59초 (`http_req_waiting`)         |
| **HTTP 요청 차단 시간** | 평균 395.18µs (`http_req_blocked`)    |
| **HTTP 연결 시간**    | 평균 325.14µs (`http_req_connecting`) |
| **HTTP 요청 전송 시간** | 평균 56.75µs (`http_req_sending`)     |
| **HTTP 응답 수신 시간** | 평균 126.57µs (`http_req_receiving`)  |

> 분석:
> - 평균 응답 시간이 6.38초로 상당히 높으며, 95% 이상의 요청이 12.46초 이내에 완료됨.
> - HTTP 연결 시간(`http_req_connecting`)과 요청 차단 시간(`http_req_blocked`)이 일정 수준 발생하여 네트워크 지연 가능성이 존재함.
> - 서버 오류(500)가 발생하지 않았으나, 성능 최적화가 필요함.

---

## 2. 병목 구간 탐색 및 개선 방안

### 주요 병목 탐색 결과
1. Redis 요청량 증가로 인해 대기 시간이 증가함.
    - 쿠폰 발급 요청이 Redis Sorted Set에 저장되는 과정에서 대기 시간이 발생함.
    - 요청량이 몰릴 경우 Redis 연산 시간이 증가하여 응답 지연이 발생할 가능성이 있음.

2. DB 커넥션 풀 부족 현상이 발생함.
    - 동시 요청 수 증가 시 MySQL 커넥션 풀이 한계에 도달함.
    - 일부 요청이 지연되거나 실패하는 현상이 발생함.

3. 스케줄러 처리 지연이 발생함.
    - 대량의 쿠폰 발급 요청을 처리하는 스케줄러가 한 번에 많은 데이터를 읽고 처리하는 구조로 되어 있음.
    - 요청이 많아질 경우 처리 속도가 저하될 가능성이 있음.

### 개선 방안
1. Redis 요청 최적화 방안을 적용함.
    - Sorted Set 활용 시 데이터 TTL 설정을 적용하여 불필요한 데이터 누적을 방지함.
    - 필요 시 Redis Cluster 도입을 고려함.

2. DB 커넥션 풀을 조정함.
    - HikariCP 설정 최적화 (`maximumPoolSize` 조정)
    - 읽기/쓰기 분리하여 Read Replica 활용
3. 스케줄러를 최적화함.
    - Batch Size 조정: 한 번에 처리하는 데이터 크기를 조정하여 효율적으로 처리함.
    - 비동기 처리 도입: Redis에서 즉시 발급 가능한 경우 스케줄러를 거치지 않고 바로 처리함.

---

## 3. 장애 대응 전략

### 예상 장애 시나리오

| 장애 유형     | 원인 및 영향                                      |
|-----------|----------------------------------------------|
| Redis 장애  | 쿠폰 발급 요청이 Redis에 저장되지 않아 대량의 요청이 DB로 직접 유입됨. |
| DB 과부하    | 동시 요청 증가로 인해 커넥션 풀이 부족해지고, 일부 요청이 실패함.       |
| API 응답 지연 | 동시 요청 증가로 인해 응답 시간이 길어지고 사용자 경험이 저하됨.        |

### 대응 방안

1. Redis 장애 대응 방안을 마련함.
    - 장애 발생 시 Fallback 전략을 적용하여 DB에 직접 저장 후 나중에 Redis 복구 시 반영함.
    - Redis Sentinel 또는 Cluster를 적용하여 가용성을 확보함.

2. DB 과부하 대응 방안을 마련함.
    - 읽기 전용 Replica를 사용하여 부하를 분산함.
    - 대량 트랜잭션을 처리하는 스케줄러의 트랜잭션 크기를 조정함.

3. API 응답 지연 대응 방안을 마련함.
    - 요청이 폭주할 경우 Rate Limiting을 적용하는 방안을 검토함.

---

## 4. 결론 및 향후 계획

이번 부하 테스트를 통해 쿠폰 발급 요청 API의 성능과 안정성을 점검하고 주요 병목 구간을 분석했습니다.

Sorted Set을 이용한 레디스에서 발급받는 스케줄러 쪽에서 병목이 발생할 수 있어 해당 부분에 개선을 하면 좋을 것 같습니다.
Redis가 현재 단일 장애지점이 될 수 있으므로 Redis Cluster를 도입하여 가용성을 높이는 것도 좋은 방안이 될 것입니다.

그리고 요청이 많은 경우 Rate Limiting을 적용하여 서버의 안정성을 높이는 것도 좋은 방안이 될 것입니다.
